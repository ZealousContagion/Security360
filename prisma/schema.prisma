generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  name      String
  password  String?
  role      String     @default("USER")
  clerkId   String?    @unique
  AuditLogs AuditLog[]

  @@index([clerkId])
  @@index([email])
}

model Customer {
  id        String       @id @default(uuid())
  name      String
  phone     String?
  address   String?
  createdAt DateTime     @default(now())
  Quotes    FenceQuote[]
  Invoices  Invoice[]

  @@index([name])
}

model FencingService {
  id               String            @id @default(uuid())
  name             String
  pricePerMeter    Decimal           @db.Decimal(10, 2)
  installationFee  Decimal           @db.Decimal(10, 2)
  supportsElectric Boolean           @default(false)
  supportsRazor    Boolean           @default(false)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  description      String?
  Quotes           FenceQuote[]
  BillOfMaterials  BillOfMaterials[]

  @@index([isActive])
}

model BillOfMaterials {
  id               String         @id @default(uuid())
  fencingServiceId String
  catalogItemId    String
  quantityPerMeter Decimal        @db.Decimal(10, 4)
  wastageFactor    Decimal        @default(1.10) @db.Decimal(5, 2)
  createdAt        DateTime       @default(now())
  fencingService   FencingService @relation(fields: [fencingServiceId], references: [id])
  catalogItem      CatalogItem    @relation(fields: [catalogItemId], references: [id], map: "bom_catalog_item_fkey")

  @@map("bill_of_materials")
  @@index([fencingServiceId])
  @@index([catalogItemId])
}

model FencingAddon {
  id          String   @id @default(uuid())
  name        String
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  pricingType String
}

model FenceQuote {
  id               String         @id @default(uuid())
  customerId       String
  fencingServiceId String
  lengthMeters     Decimal        @db.Decimal(10, 2)
  heightMeters     Decimal        @db.Decimal(10, 2)
  terrain          String
  addOnIds         String[]
  subtotal         Decimal        @db.Decimal(10, 2)
  vat              Decimal        @db.Decimal(10, 2)
  total            Decimal        @db.Decimal(10, 2)
  status           String         @default("DRAFT")
  pipelineStage    String         @default("LEAD") // LEAD, SURVEY, QUOTED, WON, LOST
  createdAt        DateTime       @default(now())
  customer         Customer       @relation(fields: [customerId], references: [id])
  fencingService   FencingService @relation(fields: [fencingServiceId], references: [id])
  Invoice          Invoice?

  @@index([customerId])
  @@index([status])
  @@index([pipelineStage])
  @@index([createdAt])
}

model Invoice {
  id            String      @id @default(uuid())
  invoiceNumber String      @unique
  customerId    String
  subtotal      Decimal     @db.Decimal(10, 2)
  vat           Decimal     @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())
  issuedAt      DateTime    @default(now())
  quoteId       String?     @unique
  status        String      @default("PENDING")
  customer      Customer    @relation(fields: [customerId], references: [id])
  quote         FenceQuote? @relation(fields: [quoteId], references: [id])
  Job           Job?
  Payments      Payment[]

  @@index([customerId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([issuedAt])
}

model Payment {
  id        String   @id @default(uuid())
  invoiceId String
  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  reference String?
  status    String   @default("PENDING")
  method    String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([status])
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  entityType  String
  entityId    String?
  performedBy String?
  createdAt   DateTime @default(now())
  metadata    Json?
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
}

model Expense {
  id          String   @id @default(uuid())
  amount      Decimal  @db.Decimal(10, 2)
  category    String
  description String
  date        DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([category])
  @@index([date])
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([read])
  @@index([createdAt])
}

model TeamMember {
  id        String   @id @default(uuid())
  name      String
  role      String
  email     String   @unique
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  Jobs      Job[]
}

model Job {
  id            String      @id @default(uuid())
  invoiceId     String      @unique
  teamMemberId  String?
  status        String      @default("SCHEDULED")
  scheduledDate DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  notes         String?
  createdAt     DateTime    @default(now())
  invoice       Invoice     @relation(fields: [invoiceId], references: [id])
  assignedTo    TeamMember? @relation(fields: [teamMemberId], references: [id])
  photos        JobPhoto[]

  @@index([teamMemberId])
  @@index([status])
  @@index([scheduledDate])
}

model JobPhoto {
  id        String   @id @default(uuid())
  jobId     String
  url       String
  type      String
  createdAt DateTime @default(now())
  job       Job      @relation(fields: [jobId], references: [id])

  @@index([jobId])
}

model CatalogItem {
  id              String            @id @default(uuid())
  name            String
  description     String?
  price           Decimal           @db.Decimal(10, 2)
  unit            String            @default("item")
  category        String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  minStockLevel   Decimal           @default(0) @db.Decimal(10, 2)
  stockLevel      Decimal           @default(0) @db.Decimal(10, 2)
  BillOfMaterials BillOfMaterials[]

  @@map("catalog_items")
}

model TaxConfig {
  id        String   @id @default(uuid())
  name      String   @default("VAT")
  rate      Decimal  @default(0.15) @db.Decimal(5, 4)
  isActive  Boolean  @default(true)
  updatedAt DateTime @updatedAt

  @@map("tax_configs")
}
